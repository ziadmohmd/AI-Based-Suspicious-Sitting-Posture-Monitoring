<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PostureGuard Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --bg-primary: #0f1236;
      --bg-secondary: #1a1f3a;
      --bg-section: #1b1f45;
      --bg-metric: #262a5a;
      --text-primary: #eef1f7;
      --accent: #007bff;
      --shadow: rgba(0,0,0,0.5);
      --shadow-light: rgba(0,0,0,0.3);
    }
    .light-mode {
      --bg-primary: #f0f4f8;
      --bg-secondary: #ffffff;
      --bg-section: rgba(255,255,255,0.8);
      --bg-metric: #e8ecf0;
      --text-primary: #2c3e50;
      --accent: #000000;
      --shadow: rgba(0,0,0,0.1);
      --shadow-light: rgba(0,0,0,0.1);
    }

    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      min-height: 100vh;
      transition: background 0.5s, color 0.5s;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-shadow: 2px 0 10px var(--shadow);
      backdrop-filter: blur(10px);
      border-radius: 0 15px 15px 0;
    }
    .sidebar h2 {
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--accent);
    }
    .sidebar a {
      text-decoration: none;
      color: var(--text-primary);
      padding: 10px;
      border-radius: 8px;
      margin: 5px 0;
      display: block;
      transition: 0.3s;
      box-shadow: inset 5px 5px 10px var(--shadow-light), inset -5px -5px 10px rgba(255,255,255,0.1);
    }
    .sidebar a:hover {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 0 10px var(--accent);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 1.8rem;
      color: var(--accent);
    }
    .theme-toggle {
      background: none;
      border: 2px solid var(--accent);
      border-radius: 20px;
      padding: 5px;
      cursor: pointer;
      font-size: 1.2em;
      transition: 0.3s;
      box-shadow: inset 3px 3px 6px var(--shadow-light), inset -3px -3px 6px rgba(255,255,255,0.1);
    }
    .theme-toggle:hover {
      box-shadow: 0 0 10px var(--accent), inset 3px 3px 6px var(--shadow-light), inset -3px -3px 6px rgba(255,255,255,0.1);
    }

    section {
      background: var(--bg-section);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px var(--shadow), inset 5px 5px 10px var(--shadow-light), inset -5px -5px 10px rgba(255,255,255,0.1);
      transition: opacity 0.5s ease-in-out;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      margin: 5px;
      transition: 0.3s;
      box-shadow: inset 5px 5px 10px var(--shadow-light), inset -5px -5px 10px rgba(255,255,255,0.1);
      position: relative;
      overflow: hidden;
    }
    button:hover {
      background: #333333;
      box-shadow: 0 0 15px var(--accent), inset 5px 5px 10px var(--shadow-light), inset -5px -5px 10px rgba(255,255,255,0.1);
    }
    button:active { transform: scale(0.98); }

    /* Ripple effect */
    .ripple {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,255,255,0.6);
      transform: scale(0);
      animation: ripple 0.6s linear;
    }
    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    .blink {
      animation: blink 1s infinite;
    }

    /* Video Feed */
    #video-feed {
      width: 100%;
      max-width: 960px;
      border-radius: 12px;
      border: 2px solid var(--accent);
      margin-bottom: 10px;
    }

    /* Metrics */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }
    .metric-box {
      background: var(--bg-metric);
      backdrop-filter: blur(5px);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 6px var(--shadow-light), inset 3px 3px 6px var(--shadow-light), inset -3px -3px 6px rgba(255,255,255,0.1);
      transition: transform 0.2s;
    }
    .metric-box:hover { transform: translateY(-3px); }

    /* Dashboard filters */
    .filters label {
      display: block;
      margin: 10px 0 5px;
    }
    .filters select, .filters input {
      padding: 8px;
      border-radius: 8px;
      border: none;
      width: 100%;
      max-width: 250px;
      margin-bottom: 10px;
      background: var(--bg-metric);
      color: var(--text-primary);
    }

    footer {
      text-align: center;
      padding: 10px;
      font-size: 0.85em;
      color: #888;
    }

    @media (max-width: 768px) {
      .sidebar { display: none; }
      body { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>PostureGuard Pro</h2>
    <a href="#monitoring">Monitoring</a>
    <a href="/admin">Admin Panel</a>
  </div>

  <div class="main-content">
    <header>
      <h1>AI-Powered Posture Monitoring</h1>
      <button class="theme-toggle" id="theme-toggle">ðŸŒ™</button>
    </header>

    <section id="monitoring">
      <h2>Live Monitoring</h2>
      <img id="video-feed" src="static/example.jpg" alt="Video Feed" style="width: 600px; height: auto; border-radius: 10px;">
      <p id="camera-error" style="color:#ff5555; display:none;">Camera not available. Check permissions.</p>
      <div>
        <button id="start-btn" class="blink">Start</button>
        <button id="stop-btn">Stop</button>
      </div>

      <div class="metrics">
        <div class="metric-box"><h3>Posture</h3><p id="posture">â€”</p></div>
        <div class="metric-box"><h3>Eye State</h3><p id="eye-state">â€”</p></div>
        <div class="metric-box"><h3>Employee</h3><p id="employee">â€”</p></div>
      </div>

      <h2>Posture Duration (sec)</h2>
      <div class="metrics">
        <div class="metric-box"><h3>Good</h3><p id="good-duration">0</p></div>
        <div class="metric-box"><h3>Slouched</h3><p id="slouched-duration">0</p></div>
        <div class="metric-box"><h3>Leaning</h3><p id="leaning-duration">0</p></div>
        <div class="metric-box"><h3>Away</h3><p id="away-duration">0</p></div>
        <div class="metric-box"><h3>Inactive</h3><p id="inactive-duration">0</p></div>
        <div class="metric-box"><h3>Total</h3><p id="total-duration">0</p></div>
      </div>

      <h2>Body Angles</h2>
      <div class="metrics">
        <div class="metric-box"><h3>Neck Flex</h3><p id="neck-flex">â€”</p></div>
        <div class="metric-box"><h3>Torso Tilt</h3><p id="torso-tilt">â€”</p></div>
        <div class="metric-box"><h3>L Elbow</h3><p id="left-elbow">â€”</p></div>
        <div class="metric-box"><h3>R Elbow</h3><p id="right-elbow">â€”</p></div>
        <div class="metric-box"><h3>L Hip</h3><p id="left-hip">â€”</p></div>
        <div class="metric-box"><h3>R Hip</h3><p id="right-hip">â€”</p></div>
      </div>
    

    <footer>
      Â© 2025 PostureGuard Pro - AI Posture Monitoring
    </footer>
  </div>

  <script>
    // Load employees for dashboard filter
    fetch('/employees').then(res => res.json())
      .then(emps => {
        const select = document.getElementById('employee-select');
        emps.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp[0];
          option.textContent = `${emp[1]} (ID: ${emp[0]})`;
          select.appendChild(option);
        });
      });

    // Monitoring buttons and metrics update
    const videoFeed = document.getElementById('video-feed');
    const cameraError = document.getElementById('camera-error');
    document.getElementById('start-btn').onclick = () => {
      fetch('/start', { method:'POST' }).then(res => res.json()).then(data => {
        if(data.ok){ videoFeed.src='/video_feed?nocache='+Date.now(); videoFeed.style.display='block'; cameraError.style.display='none'; }
        else { videoFeed.style.display='none'; cameraError.style.display='block'; }
      });
    };
    document.getElementById('stop-btn').onclick = () => {
      fetch('/stop', { method:'POST' }).then(res => res.json()).then(data => {
        if(data.ok){ videoFeed.src=''; videoFeed.style.display='none'; cameraError.style.display='none'; }
      });
    };

    function updateMetrics(){
      fetch('/metrics').then(res=>res.json()).then(data=>{
        document.getElementById('posture').textContent=data.posture;
        document.getElementById('eye-state').textContent=data.eye_state;
        document.getElementById('employee').textContent=data.employee_name||'Unknown';
        document.getElementById('good-duration').textContent=Math.round(data.durations_sec.Good);
        document.getElementById('slouched-duration').textContent=Math.round(data.durations_sec.Slouched);
        document.getElementById('leaning-duration').textContent=Math.round(data.durations_sec.Leaning);
        document.getElementById('away-duration').textContent=Math.round(data.durations_sec.Away);
        document.getElementById('inactive-duration').textContent=Math.round(data.durations_sec.Inactive);
        const total=Object.values(data.durations_sec).reduce((a,b)=>a+b,0);
        document.getElementById('total-duration').textContent=Math.round(total);
        document.getElementById('neck-flex').textContent=data.angles.neck_flex_deg||'â€”';
        document.getElementById('torso-tilt').textContent=data.angles.torso_tilt_deg||'â€”';
        document.getElementById('left-elbow').textContent=data.angles.left_elbow_deg||'â€”';
        document.getElementById('right-elbow').textContent=data.angles.right_elbow_deg||'â€”';
        document.getElementById('left-hip').textContent=data.angles.left_hip_deg||'â€”';
        document.getElementById('right-hip').textContent=data.angles.right_hip_deg||'â€”';
      }).catch(err=>console.error(err));
    }
    setInterval(updateMetrics,1000);

    // Dashboard refresh
    const refreshDashboard = () => {
      let url='/dashboard_html';
      const dateStart=document.getElementById('date-start').value;
      const dateEnd=document.getElementById('date-end').value;
      const sortBy=document.getElementById('sort-by').value;
      const employeeId=document.getElementById('employee-select').value;
      if(dateStart||dateEnd||sortBy||employeeId){ url+='?'; if(dateStart) url+=`date_start=${dateStart}&`; if(dateEnd) url+=`date_end=${dateEnd}&`; if(sortBy) url+=`sort_by=${sortBy}&`; if(employeeId) url+=`employee_id=${employeeId}&`; }
      fetch(url).then(res=>res.text()).then(html=>document.getElementById('dashboard-charts').innerHTML=html);
    }
    document.getElementById('refresh-dashboard-btn').onclick=refreshDashboard;
    document.getElementById('apply-filters-btn').onclick=refreshDashboard;

    // Quick capture
    document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='q') document.getElementById('capture-dashboard-btn').click(); });

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
      body.classList.add('light-mode');
      themeToggle.textContent = 'â˜€ï¸';
    }
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('light-mode');
      const isLight = body.classList.contains('light-mode');
      themeToggle.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });

    // Ripple effect for buttons
    document.addEventListener('click', function(e) {
      if (e.target.tagName === 'BUTTON') {
        const button = e.target;
        const circle = document.createElement('span');
        const diameter = Math.max(button.clientWidth, button.clientHeight);
        const radius = diameter / 2;
        circle.style.width = circle.style.height = `${diameter}px`;
        circle.style.left = `${e.clientX - button.offsetLeft - radius}px`;
        circle.style.top = `${e.clientY - button.offsetTop - radius}px`;
        circle.classList.add('ripple');
        const ripple = button.getElementsByClassName('ripple')[0];
        if (ripple) ripple.remove();
        button.appendChild(circle);
      }
    });

    // Smooth transitions for sections
    const sections = document.querySelectorAll('section');
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = '1';
        } else {
          entry.target.style.opacity = '0.5';
        }
      });
    });
    sections.forEach(section => {
      section.style.opacity = '0.5';
      observer.observe(section);
    });
  </script>
</body>
</html>